<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Station Manager - FieldStation42</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@3.0.0/build/pure-min.css">
    <link rel="stylesheet" href="https://unpkg.com/purecss@3.0.0/build/grids-responsive-min.css">
    <link rel="stylesheet" id="theme-css" href="/static/themes/default.css">
    <link rel="stylesheet" href="/static/station_ui.css">
</head>
<body>
    <script src="/static/common.js"></script>
    <script src="/static/fs42_client.js"></script>
    <script>
        let allStations = [];
        let filteredStations = [];

        // Initialize page layout
        document.addEventListener('DOMContentLoaded', async function() {
            window.fs42Common.initTheme();

            const content = `
                <div class="page-header">
                    <div>
                        <h1 style="margin:0;">Station Manager</h1>
                        <p style="color:#8b949e;margin:0.5em 0 0 0;">Manage your FieldStation42 channel configurations</p>
                    </div>
                    <button class="pure-button pure-button-primary" onclick="showTemplateSelector()">
                        + Create New Station
                    </button>
                </div>

                <div class="filter-bar">
                    <select id="type-filter" class="pure-input">
                        <option value="all">All Types</option>
                        <option value="standard">Standard</option>
                        <option value="web">Web</option>
                        <option value="guide">Guide</option>
                        <option value="loop">Loop</option>
                        <option value="streaming">Streaming</option>
                    </select>
                    <div class="search-container">
                        <input id="search-input" type="text" class="pure-input" placeholder="Search stations...">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>

                <div id="station-list">
                    <div class="loading-spinner">
                        <p>Loading stations...</p>
                    </div>
                </div>

                <!-- Template Selector Modal -->
                <div id="template-modal" class="modal" style="display:none;">
                    <div class="modal-overlay" onclick="hideTemplateSelector()"></div>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Create New Station</h2>
                            <button class="modal-close" onclick="hideTemplateSelector()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <p style="color:#8b949e;margin-bottom:1.5em;">Choose a template to get started:</p>
                            <div class="template-grid">
                                <div class="template-card" onclick="createFromTemplate('standard')">
                                    <div class="template-icon">üì∫</div>
                                    <h3>Standard</h3>
                                    <p>Traditional scheduled TV with time slots and programming</p>
                                </div>
                                <div class="template-card" onclick="createFromTemplate('web')">
                                    <div class="template-icon">üåê</div>
                                    <h3>Web Page</h3>
                                    <p>Embed a web page as a channel</p>
                                </div>
                                <div class="template-card" onclick="createFromTemplate('loop')">
                                    <div class="template-icon">üîÑ</div>
                                    <h3>Loop</h3>
                                    <p>Continuous playlist of content</p>
                                </div>
                                <div class="template-card" onclick="createFromTemplate('guide')">
                                    <div class="template-icon">üìã</div>
                                    <h3>Guide</h3>
                                    <p>Scrolling guide with programming schedule</p>
                                </div>
                                <div class="template-card" onclick="createFromTemplate('streaming')">
                                    <div class="template-icon">üì°</div>
                                    <h3>Streaming</h3>
                                    <p>External stream sources</p>
                                </div>
                                <div class="template-card" onclick="createFromTemplate('blank')">
                                    <div class="template-icon">‚ö°</div>
                                    <h3>Blank</h3>
                                    <p>Minimal configuration for advanced users</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.innerHTML = await window.fs42Common.createPageLayout('', content);

            // Load stations
            await loadStations();

            // Setup event listeners
            document.getElementById('type-filter').addEventListener('change', applyFilters);
            document.getElementById('search-input').addEventListener('input', applyFilters);
        });

        async function loadStations() {
            try {
                const data = await window.fs42Api.get('stations');
                // Extract station_conf from each station object
                allStations = (data.stations || []).map(s => s.station_conf);
                filteredStations = [...allStations];

                // Sort by channel number
                allStations.sort((a, b) => (a.channel_number || 0) - (b.channel_number || 0));
                filteredStations.sort((a, b) => (a.channel_number || 0) - (b.channel_number || 0));

                renderStations();
            } catch (error) {
                document.getElementById('station-list').innerHTML = `
                    <div class="error-message">
                        <strong>Error loading stations:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            }
        }

        function applyFilters() {
            const typeFilter = document.getElementById('type-filter').value;
            const searchQuery = document.getElementById('search-input').value.toLowerCase();

            filteredStations = allStations.filter(station => {
                // Type filter
                if (typeFilter !== 'all' && (station.network_type || 'standard') !== typeFilter) {
                    return false;
                }

                // Search filter
                if (searchQuery) {
                    const nameMatch = (station.network_name || '').toLowerCase().includes(searchQuery);
                    const channelMatch = String(station.channel_number || '').includes(searchQuery);
                    if (!nameMatch && !channelMatch) {
                        return false;
                    }
                }

                return true;
            });

            renderStations();
        }

        function renderStations() {
            const container = document.getElementById('station-list');

            if (filteredStations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No stations found</h3>
                        <p>Try adjusting your filters or search query.</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="station-cards">';

            for (const station of filteredStations) {
                const name = escapeHtml(station.network_name || 'Unnamed Station');
                const channel = station.channel_number || 'N/A';
                const type = station.network_type || 'standard';
                const description = getStationDescription(station);

                html += `
                    <div class="station-card">
                        <div class="station-card-header">
                            <div class="station-card-title-row">
                                <h3 class="station-card-name">${name}</h3>
                                <span class="station-card-channel">#${channel}</span>
                            </div>
                            <div class="station-card-meta">
                                <span class="station-card-type station-type-${type}">${type}</span>
                            </div>
                        </div>
                        <div class="station-card-description">${description}</div>
                        <div class="station-card-actions">
                            <button class="pure-button pure-button-primary" onclick="editStation('${escapeHtml(station.network_name)}')">
                                Edit Config
                            </button>
                            <button class="pure-button" onclick="duplicateStation('${escapeHtml(station.network_name)}')">
                                Duplicate
                            </button>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function getStationDescription(station) {
            const type = station.network_type || 'standard';

            switch(type) {
                case 'standard':
                    const increment = station.schedule_increment || 30;
                    const commercial = station.commercial_free ? 'Commercial-free' : 'With commercials';
                    return `${commercial} &bull; ${increment}-min intervals`;

                case 'web':
                    const url = station.web_url || 'No URL set';
                    return `Web page channel<br><small style="color:#61afef;">${escapeHtml(url)}</small>`;

                case 'guide':
                    const messages = station.messages?.length || 0;
                    const images = station.images?.length || 0;
                    return `Program guide &bull; ${messages} message(s) &bull; ${images} image(s)`;

                case 'loop':
                    const dir = station.content_dir || 'No directory set';
                    return `Continuous loop<br><small style="color:#61afef;">${escapeHtml(dir)}</small>`;

                case 'streaming':
                    const streams = station.streams?.length || 0;
                    return `External streams &bull; ${streams} source(s)`;

                default:
                    return 'Custom configuration';
            }
        }

        function editStation(networkName) {
            window.location.href = `station_editor.html?station=${encodeURIComponent(networkName)}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Template selector modal functions
        function showTemplateSelector() {
            document.getElementById('template-modal').style.display = 'flex';
        }

        function hideTemplateSelector() {
            document.getElementById('template-modal').style.display = 'none';
        }

        async function createFromTemplate(templateName) {
            hideTemplateSelector();

            try {
                // Load the template
                const response = await fetch(`/static/templates/${templateName}.json`);
                if (!response.ok) {
                    throw new Error(`Failed to load template: ${response.statusText}`);
                }
                const template = await response.json();

                // Suggest next available channel number
                const channelNumber = await findNextAvailableChannel();
                template.station_conf.channel_number = channelNumber;

                // Store template in sessionStorage and navigate to editor
                sessionStorage.setItem('newStationTemplate', JSON.stringify(template));
                window.location.href = 'station_editor.html?mode=create';

            } catch (error) {
                alert(`Error loading template: ${error.message}`);
            }
        }

        async function duplicateStation(networkName) {
            try {
                // Fetch the existing station
                const data = await window.fs42Api.get(`stations/${encodeURIComponent(networkName)}`);
                const config = data.station_config;

                // Create a copy with modified name and channel
                const newName = generateDuplicateName(config.network_name);
                const newChannel = await findNextAvailableChannel();

                config.network_name = newName;
                config.channel_number = newChannel;

                // Store in sessionStorage and navigate to editor
                sessionStorage.setItem('newStationTemplate', JSON.stringify(config));
                window.location.href = 'station_editor.html?mode=create';

            } catch (error) {
                alert(`Error duplicating station: ${error.message}`);
            }
        }

        function generateDuplicateName(originalName) {
            // Check if name already ends with " 2", " 3", etc.
            const match = originalName.match(/^(.*?)\s+(\d+)$/);

            if (match) {
                const baseName = match[1];
                let num = parseInt(match[2]);

                // Find next available number
                while (allStations.some(s => s.network_name === `${baseName} ${num}`)) {
                    num++;
                }
                return `${baseName} ${num}`;
            } else {
                // No number suffix, try " 2"
                if (!allStations.some(s => s.network_name === `${originalName} 2`)) {
                    return `${originalName} 2`;
                }

                // " 2" exists, find next available
                let num = 3;
                while (allStations.some(s => s.network_name === `${originalName} ${num}`)) {
                    num++;
                }
                return `${originalName} ${num}`;
            }
        }

        async function findNextAvailableChannel() {
            const usedChannels = allStations.map(s => s.channel_number);

            // Find first available channel starting from 1
            for (let i = 1; i < 1000; i++) {
                if (!usedChannels.includes(i)) {
                    return i;
                }
            }

            return 999; // Fallback
        }
    </script>
</body>
</html>
